<!doctype html>
<html lang="en" class="sketch full">
<head>
  
<title>Boids</title>
 
<meta name="description" content="&#x2F;assets&#x2F;images&#x2F;sketchbook&#x2F;boids@2x.png" />

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<meta content="width=device-width" name="viewport" />
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
<link rel="stylesheet" href="/main.css" />
<link
  href="/apple-touch-icon-57x57.png"
  rel="apple-touch-icon-precomposed"
  sizes="57x57"
/>
<link
  href="/apple-touch-icon-114x114.png"
  rel="apple-touch-icon-precomposed"
  sizes="114x114"
/>
<link
  href="/apple-touch-icon-72x72.png"
  rel="apple-touch-icon-precomposed"
  sizes="72x72"
/>
<link
  href="/apple-touch-icon-144x144.png"
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
/>
<link
  href="/apple-touch-icon-120x120.png"
  rel="apple-touch-icon-precomposed"
  sizes="120x120"
/>
<link
  href="/apple-touch-icon-152x152.png"
  rel="apple-touch-icon-precomposed"
  sizes="152x152"
/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" />
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter&family=Open+Sans&display=swap"
  rel="stylesheet"
/>

</head>

<body>
  

<div class="navigation">
  <input type="checkbox" id="navigation-controller" />

  <div class="navigation-container">
    <label for="navigation-controller" class="navigation-home">⌘</label>

    <div class="navigation-menu">
      
      <a class="navigation-menu__link" href="&#x2F;"
        >🏕️ <span>home</span></a
      >
      
      <a class="navigation-menu__link" href="&#x2F;blog"
        >📖 <span>blog</span></a
      >
      
      <a class="navigation-menu__link" href="&#x2F;sketchbook"
        >🌱 <span>sketchbook</span></a
      >
      
      <a class="navigation-menu__link" href="&#x2F;feed"
        >📟 <span>feed</span></a
      >
      
      <a class="navigation-menu__link" href="&#x2F;other"
        >🔮 <span>other</span></a
      >
      
    </div>
  </div>

  <div class="navigation-menu-mobile">
    
    <a class="navigation-menu-mobile__link" href="&#x2F;"
      >🏕️ <span>home</span></a
    >
    
    <a class="navigation-menu-mobile__link" href="&#x2F;blog"
      >📖 <span>blog</span></a
    >
    
    <a class="navigation-menu-mobile__link" href="&#x2F;sketchbook"
      >🌱 <span>sketchbook</span></a
    >
    
    <a class="navigation-menu-mobile__link" href="&#x2F;feed"
      >📟 <span>feed</span></a
    >
    
    <a class="navigation-menu-mobile__link" href="&#x2F;other"
      >🔮 <span>other</span></a
    >
    

    <label
      for="navigation-controller"
      class="navigation-menu-mobile__link navigation-menu-mobile__close"
      >close menu</label
    >
  </div>
</div>


    <div class="fullscreen">
  <canvas id="view"></canvas>
</div>
<script type="text/javascript" src="/assets/js/lodash.min.js"></script>
<script type="text/javascript" src="/assets/js/ramda.min.js"></script>
<script type="text/javascript" src="/assets/js/dat.gui.min.js"></script>
<script type="text/javascript" src="/assets/js/gpu-browser.min.js"></script>
<script type="text/javascript">
/*
TODO:
- move walls off screen
- better styles
- better clear function
*/

const DEBUG = false;
const BOIDS = 300;
const TIMEOUT = 0;
const BORDER = 100;
const C = 2.1;
const M = 1.9;
const F = 0.99;

let view;
let ctx;
let width;
let height;
let play;
let distances;
let yMin;
let yMax;
let xMin;
let xMax;
let rAF;
let computeForces;
let gpu;
let world;

function applyForces(things) {
  let y = things[this.thread.x][0];
  let x = things[this.thread.x][1];

  let dy = things[this.thread.x][2] + Math.random() * 0.2 - 0.1;
  let dx = things[this.thread.x][3] + Math.random() * 0.2 - 0.1;
  dy *= this.constants.F;
  dx *= this.constants.F;

  let countAlign = 0;
  let alignY = 0;
  let alignX = 0;
  let countCenter = 1;
  let centerX = x;
  let centerY = y;
  let countAvoid = 1;
  let avoidX = x;
  let avoidY = y;

  for (let i = 0; i < this.constants.size; i++) {
    if (i !== this.thread.x) {
      const x2 = things[i][1];
      const y2 = things[i][0];
      const d = Math.pow(x2 - x, 2) + Math.pow(y2 - y, 2);

      if (d < 5000) {
        countAlign += 1;
        alignY += things[i][2];
        alignX += things[i][3];
      }

      if (d < 1000 && d > 4000) {
        countCenter += 1;
        centerY += y2;
        centerX += x2;
      }

      if (d < 2000) {
        countAvoid += 1;
        avoidY += y2;
        avoidX += x2;
      }
    }
  }

  if (countAlign > 0) {
    dy += (alignY / countAlign) * 0.03;
    dx += (alignX / countAlign) * 0.03;
  }

  if (countCenter > 0) {
    dy += (y - (centerY / countCenter)) * 0.004;
    dx += (x - (centerX / countCenter)) * 0.004;
  }

  if (countAvoid > 0) {
    dy += (y - (avoidY / countAvoid)) * 0.004;
    dx += (x - (avoidX / countAvoid)) * 0.004;
  }

  const hW = this.constants.width / 2;
  const hH = this.constants.height / 2;

  dy += (hH - y)/hH * 0.002;
  dx += (hW - x)/hW * 0.002;

  const velocity = Math.pow(dy, 2) + Math.pow(dx, 2);

  if (velocity > this.constants.C) {
    const t = Math.atan2(dy, dx);
    dy = Math.sin(t) * this.constants.C;
    dx = Math.cos(t) * this.constants.C;
  }

  if (velocity < this.constants.M) {
    const t = Math.atan2(dy, dx);
    dy = Math.sin(t) * this.constants.M;
    dx = Math.cos(t) * this.constants.M;
  }

  if (y + dy < -this.constants.BORDER || y + dy > this.constants.height + this.constants.BORDER) {
    dy *= -1;
  }

  if (x + dx < -this.constants.BORDER || x + dx > this.constants.width + this.constants.BORDER) {
    dx *= -1;
  }

  y = Math.min(
    this.constants.height + this.constants.BORDER,
    Math.max(-this.constants.BORDER, dy + y),
  );
  x = Math.min(
    this.constants.width + this.constants.BORDER,
    Math.max(-this.constants.BORDER, dx + x),
  );

  return [
    y,
    x,
    dy,
    dx,
  ];
}



// Get pixel
const px = (x) => x;
const py = (y) => y;

const update = () => {
  // console.log(distances.toArray());
  world.things = computeForces(world.things);
};

const renderBoid = ([y, x, dy, dx]) => {
  ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(px(x), py(y));
  ctx.lineTo(px(x) + dx * 3, py(y) + dy * 3);
  ctx.stroke();
};

const renderThing = (thing) => {
  renderBoid(thing);
};

const render = () => {
  world.things.forEach(renderThing);
};

const clearThing = ([y, x, dy, dx]) => {
  ctx.clearRect(x-5, y-5, 10, 10);
}

const clear = () => {
  ctx.fillStyle = 'rgba(128, 128, 128, 0.2)';
  ctx.fillRect(0, 0, width, height);
  // world.things.forEach(clearThing);
};

const loop = () => {
  clear();
  update();
  render();

  if (TIMEOUT !== -1) {
    rAF = window.requestAnimationFrame(loop);
  }
};

const start = () => {
  console.log('start');
  play = true;
  loop();

  if (TIMEOUT > 0) {
    setTimeout(() => {
      stop();
    }, TIMEOUT);
  }
};

const stop = () => {
  window.cancelAnimationFrame(rAF);
  if (computeForces) {
	  computeForces.destroy();
  }
  console.log('stop');
}

const setup = () => {
  console.log('setup');
  view = document.getElementById('view');
  ctx = view.getContext('2d');

  gpu = new GPU({
    // mode: 'cpu',
    // mode: 'webgl2',
  });

  width = window.innerWidth;
  height = window.innerHeight;

  view.style.width = width + 'px';
  view.style.height = height + 'px';
  ctx.canvas.width  = width;
  ctx.canvas.height = height;

  world = {
    things: [],
  };

  world.things = world.things.concat(
    R.times(() => ([
      Math.random() * height, // y
      Math.random() * width, // x
      Math.random() * 3 - 1.5, // dy
      Math.random() * 3 - 1.5, // dx
      // 'boid', // type
    ]), BOIDS),
  );

  computeForces = gpu.createKernel(applyForces)
    .setOutput([
      world.things.length,
    ])
    .setConstants({
      size: world.things.length,
      C,
      M,
      F,
      BORDER,
      width,
      height,
    });
};

stop();
setup();
start();



</script>

    <div class="sketch__share">
    <a class="sketch__share--glitch" href="https://glitch.com/edit/?utm_content=project_paper-push-6zd203q7f5&utm_source=remix_this&utm_medium=button&utm_campaign=glitchButton#!/remix/paper-push-6zd203q7f5">
        <img src="https://cdn.glitch.com/2bdfb3f8-05ef-4035-a06e-2043962a3a13%2Fremix%402x.png?1513093958726" alt="remix this" height="33">
    </a>
    <div>

  
</body>
</html>
